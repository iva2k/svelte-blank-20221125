# Creating: Blank SvelteKit App + Tauri + Capacitor + Storybook + Prettier + ESLint + Stylelint + Postcss

This file describes how this app was created.

## Software Mantra

### DRY

DRY - Don't-Repeat-Yourself. Knowledge should always reside in a single place. If code of more than 3 steps is repeated twice, maybe... if thrice - for sure refactor it so it resides in a single place and used from there. DRY is avoiding knowledge duplication (and splintering) and reducing the repetition of code patterns in favor of abstractions and avoiding redundancy. It also can be explained as SST - Single-SourceOf-Truth principle - "every piece of knowledge must have a single, unambiguous, authoritative representation within a system". Code can still be duplicated - it is sometimes a judgement call for balancing with other principles.

### KISS

KISS - Keep-It-Simple,Stupid. Keep the code simple and clear, making it easy to understand. If code needs comments, think hard - the code can probably be simplified by renaming, restructuring, breaking up.

## Prerequisites

Please follow the [Tauri Getting Started Guide](https://tauri.studio/en/docs/getting-started/intro#steps) to setup your system with the required Rust toolchain.

## create-svelte

Svelte scaffolding is set up by [`create-svelte`](https://github.com/sveltejs/kit/tree/master/packages/create-svelte).

```bash
# create a new project in my-app, use TypeScript syntax, add ESLint, Prettier, Playwright
npm create svelte@latest my-app
cd my-app
pnpm install
git init && git add -A && git commit -m "Initial commit" # (optional)
```

## Developing Locally

This application is built like a typical Node.js application. However, instead of `npm`, [`pnpm`](https://pnpm.io/) is used for package management.

> **Note:** You may use `yarn` or `npm`, but only a `pnpm` lockfile is included.

### Start development server

```bash
pnpm run dev

# or start the development server and open the app in a new browser tab
pnpm run dev -- --open
```

## Fix Issues That Might Come Up

Run `pnpm run XXX` replacing XXX for each of the scripts in `package.json`. It's a good idea to fix all errors and warnings that might come up, and re-check after each major addition.

### Issue with imports linting

<https://github.com/sveltejs/kit/issues/1560>

Fix:

Install `eslint-import-resolver-typescript` package for resolving aliases set by "path" in `tsconfig.json`, and install `eslint-plugin-import` package for checking imports:

```bash
pnpm i -D eslint-plugin-import eslint-import-resolver-typescript
```

Add to `.eslintrc.cjs` file:

```cjs
{
  extends: [
    'eslint:recommended',
    'plugin:@typescript-eslint/recommended',
+    'plugin:import/recommended',
    'prettier'
  ],
  plugins: [
    ...
+    'import'
  ],
  settings: {
+    'import/resolver': {
+      typescript: {}
+    }
    ...
  },
  parserOptions: {
+    project: ['./tsconfig.json', './tsconfig.lint.json'],
+    tsconfigRootDir: './',
    ...
  }
}
```

Create file `tsconfig.lint.json` with:

```json
{
  "extends": "./tsconfig.json",
  "include": ["./playwright.config.ts", "./svelte.config.js", "./tests/**/*.ts"]
}
```

Add few lines to tsconfig.json:

```json
{
  "extends": "./.svelte-kit/tsconfig.json",
  "compilerOptions": {
    ...
+    "outDir": ".types",
+    "paths": {
+      "$app/*": ["./node_modules/@sveltejs/kit/src/runtime/app/*"],
+      "$lib": ["./src/lib"],
+      "$lib/*": ["./src/lib/*"]
+    }
  },
+  "exclude": ["./node_modules/**", ".svelte-kit/**", ".types"]
}
```

Some background info on these changes:

- Svelte-kit generates `.svelte-kit/tsconfig.json` which is called by "extend" in `./tsconfig.json`.
- TypeScript does not have a true extend mechanism (it is really just an override).
- There are `include` and `exclude` in `.svelte-kit/tsconfig.json`, so can't add to those. `include` is generated, `exclude` is static, so we can replace `exclude` with low risk of it breaking later (there is still some risk, just keep in mind where to look should anything break after an update).
- This fix uncovers a hidden issue in @sveltejs/kit - there are some missing types in the published package. Run `pnpm run check` or `tsc` to see the "type not found" errors ("outDir" addition above just redirects the files generated by `tsc` command so they don't clash with existing .js files). Filed issue <https://github.com/sveltejs/kit/issues/5114>. Seems to not be happening anymore with @sveltejs/kit@1.0.0-next.561 due to runtime/app stashed under node_modules.

### Issue "Could not detect a supported production environment" when running `pnpm run build`

> Could not detect a supported production environment. See <https://kit.svelte.dev/docs/adapters> to learn how to configure your app to run on the platform of your choosing

Fix:

See [Remove Default Sever](#remove-default-server) below.

## Additions

### Remove Default Server

For using Tauri (standalone app) - is supposed to explicitly opt out of SvelteKit\'s assumption needing a server. Just attach the @sveltejs/adapter-static in `svelte.config.js`:

```bash
pnpm i -D @sveltejs/adapter-static
```

```js
// svelte.config.js
- import adapter from '@sveltejs/adapter-auto';
+ import adapter from '@sveltejs/adapter-static';
```

Note: Latest svelte-kit demo app uses dynamic routes (in sverdle page) that don't work with adapter-static, to continue, should remove that whole section `rm -rf ./src/routes/sverdle/` and any links to the sverdle routes in the source files.
Tauri-based app could still use a server if needed. Add and setup a necessary adapter as needed, see <https://github.com/sveltejs/kit/tree/master/packages/adapter-static#spa-mode>.

### Add Tauri

Add desktop support using Tauri (version 1.2 as of writing time).

Note: iOS and Android support is promised in Tauri discussions, but not implemented yet as of 2022-11.

```bash
pnpm i -D @tauri-apps/api @tauri-apps/cli
```

Add scripts to package.json:

```json
   {
     scripts {
-      "dev": "vite dev",
-      "build": "vite build",
+      "dev": "tauri dev",
+      "build": "tauri build",
+      "svelte:dev": "vite dev --port 3000",
+      "svelte:build": "vite build",
+      "tauri": "tauri",
     }
   }
```

```bash
pnpm run tauri init
# What is your app name? - svelte-blank-20221125
# What should the window title be? - svelte-blank-20221125
# Where are your web assets (HTML/CSS/JS) located, relative to the "<current dir>/src-tauri/tauri.conf.json" file that will be created? - ../build
# What is the url of your dev server? - http://localhost:3000
# What is your frontend dev command? - pnpm run svelte:dev
# What is your frontend build command? - pnpm run svelte:build
```

Add `export ssr = false` to `src/routes/+layout.svelte`:

```ts
<script>
  import Header from './Header.svelte';
  import './styles.css';
+ // For Tauri:
+ export const prerender = true;
+ export const ssr = false;
</script>
```

Change bundle identifier (to remove the issue "Error: You must change the bundle identifier in `tauri.conf.json > tauri > bundle > identifier`. The default value `com.tauri.dev` is not allowed as it must be unique across applications.")

```json
// src-tauri/tauri.conf.json
{
  ...
  "tauri": {
    ...
    "bundle": {
      ...
-      "identifier": "com.tauri.dev",
+      "identifier": "com.iva2k.svelte-blank-20221125",
      ...
```

### Add Storybook

```bash
## pnpm is a bit tricky with storybook install, use `pnpx` with "-s" flag to skip installing dependencies.
## see https://github.com/storybookjs/storybook/issues/12995#issuecomment-813630999
pnpx sb init -s --builder @storybook/builder-vite
pnpm install
pnpm install -D @storybook/addon-controls @storybook/addon-docs @storybook/addon-svelte-csf
```

Add peer dependencies (some may be already installed):

```bash
pnpm i -D vite @babel/core babel-loader @storybook/builder-webpack5 @storybook/core-common @storybook/addons @storybook/api @storybook/client-api @storybook/client-logger @storybook/node-logger
pnpm i -D @storybook/components @storybook/core-events @storybook/theming
# The React packages were peer dependencies, somehow they leaked into storybook core dependencies:
pnpm i -D react@^17.0.0 react-dom@17.0.0 @mdx-js/react @types/react@^17.0.0 webpack@^5.73.0
# These packages were throwing errors in "build-storybook" script:
pnpm i -D @storybook/preview-web @storybook/addon-backgrounds @storybook/addon-measure @storybook/addon-outline @storybook/channel-postmessage @storybook/channel-websocket
# These packages fix build errors in Storybook/Vite/pnpm
pnpm i -D @prefresh/vite @prefresh/core preact @mdx-js/preact
```

One might ask - why add react et.al.? Storybook uses `react` & `react-dom` for its UI. Some of @storybook/addon-\* packages list them as peer dependencies, but it does not work well in npm package mess and breaks things. Current solution is to add react and all related packages as devDependencies.

Another ongoing problem with Storybook is heavy reliance on webpack4 and slow migration toward webpack5, and further, it impossible to cleanly cut over to vite and remove all webpack versions as of 2022-06.

Disable Storybook telemetry and add Svelte CSF:

```js
// .storybook/main.js
module.exports = {
  addons: [
     ...
+    '@storybook/addon-svelte-csf',
     ...
  ],
  core: {
+    disableTelemetry: true, // ðŸ‘ˆ Disables telemetry
  }
};
```

Remove example stories and components:

```bash
npx rimraf src/stories
```

### Solve Storybook Issues

#### Preprocess in .storybook/main.js

It turned out that storybook `main.js` trying to import preprocess from `svelte.config.js` is not viable (import is async, returns Promis, and can't await in top-level .cjs files). The solution was to hard-code same preprocess in `.storybook/main.js` same as in `svelte.config.js`.

```js
// .storybook/main.cjs
+ const preprocess = require('svelte-preprocess');
module.exports = {
  ...
  svelteOptions: {
-    preprocess: require('../svelte.config.js').preprocess
+    preprocess: preprocess(),
  },
```

#### Vite $app and $lib aliases

See <https://github.com/storybookjs/storybook/issues/14952>

Add vite config to .storybook/main.cjs:

```js
module.exports = {
+  async viteFinal(config) {
+    config.resolve.alias = {
+      ...config.resolve.alias,
+      // $app: path.resolve('./.svelte-kit/dev/runtime/app')
+      $lib: path.resolve(__dirname, '../src/lib')
+      // $components: path.resolve(__dirname, '../src/lib/components')
+    };
+    return config;
+  },
  ...
};
```

#### Node version

Note: As of 2022-0522 Node 17 and 18 have breaking changes (migrated to ssl3):

- `Error: error:0308010C:digital envelope routines::unsupported`
- <https://github.com/webpack/webpack/issues/14532>
- <https://github.com/storybookjs/storybook/issues/18019>
- <https://github.com/storybookjs/storybook/issues/16555>

One solution would be to use node<17.0.0 in package.json "engines" and engine-strict=true in .npmrc, however...

The problem with node<17.0.0 is it breaks playwright which requires node>17. No solution to use playwright with node<17 yet. Argh!

For all other issues, adding `cross-env NODE_OPTIONS=--openssl-legacy-provider` to all affected scripts (storybook ones) in `package.json` is the only practical solution for now (it opens up old security vulnerabilities in legacy openssl).

```bash
pnpm i -D cross-env
```

TODO: (blocked by upstream) When there's a fix for node>17 and storybook / webpack@4, remove `NODE_OPTIONS=--openssl-legacy-provider` from `package.json`.

#### Using \*.stories.svelte files

An open/unresolved issue is storybook's v6.5.3 storyStoreV7=true not parsing `.stories.svelte` files. And storyStoreV7=false does not load stories at all (no filed issues). So use only `.stories.tsx` for now.

<https://github.com/storybookjs/storybook/issues/16673>

Finally, got Storybook working with stories (.tsx, not .svelte) for Counter and Header (after reworking Header into Header + PureHeader). However, Counter.svelte has Typescript, and Storybook chokes on it, similar to this issue:

<https://stackoverflow.com/questions/70681325/storybook-vite-svelte-typescript-typescript-not-being-processed-in-st>

That references a bug that has been fixed, however, I'm still getting Storybook not taking .svelte components with Typescript.

### Add @storybook/addon-a11y

```bash
pnpm i -D @storybook/addon-a11y
```

```js
module.exports = {
  ...
  addons: [
    ...
+   '@storybook/addon-a11y'
  ]
```


### Add Prettier & ESLint Rules, Stylelint, Postcss and Autoprefixer

ESLint and Prettier is already part of Svelte Kit installation, so some of the packages below are already present.

#### Stylelint and additional ESLint rules (Storybook)

```bash
pnpm install -D stylelint @ronilaukkarinen/stylelint-a11y stylelint-config-standard stylelint-config-recommended
pnpm install -D eslint-plugin-storybook
```

Note: stylelint-a11y original creator / maintainer is AWOL, using an updated and maintained fork.

Edit `.eslintrc.cjs` file:

```js
// .eslintrc.cjs
module.exports = {
  ...
  extends: [
     'eslint:recommended',
     'plugin:@typescript-eslint/recommended',
     'plugin:import/recommended',
+    'plugin:storybook/recommended',
     'prettier'
  ],
  ...
  parserOptions: {
     project: ['./tsconfig.json', './tsconfig.lint.json'],
     tsconfigRootDir: './',
     sourceType: 'module',
     ecmaVersion: 2020,
+    extraFileExtensions: ['.svelte']
  },
  ...
+  rules: {
+    'import/no-mutable-exports': 'off'
+  }
};
```

#### Postcss, Autoprefixer

Autoprefixer is a PostCSS plugin to parse CSS and add vendor prefixes to CSS rules using values from [Can I Use](https://caniuse.com/). It is recommended by Google and used in Twitter and Alibaba.

```bash
pnpm install -D postcss postcss-cli postcss-import postcss-nesting postcss-html autoprefixer
```

Add file `postcss.config.cjs` with the following contents:

```js
const autoprefixer = require('autoprefixer');

const config = {
  plugins: {
    'postcss-import': {},
    'postcss-nesting': {},
    autoprefixer
  }
};

module.exports = config;
```

#### Prettier and additional Stylelint rules

```bash
pnpm install -D prettier stylelint-config-prettier stylelint-config-html
```

#### Create Stylelint configuration

Add file `.stylelintrc.json`:

```json
// .stylelintrc.json
{
  ... see file in the repo
}
```

#### VSCode formatOnSave

VSCode can format all documents on save, and it should match Stylelint & Prettier.

Some issues can be with VSCode user settings that are not visible right away. If saving any files and then running `pnpm format` shows those files as changed in the process, check "editor.defaultFormatter" for that file type.

For example, VSCode would re-format .json files differently. It turns out VSCode was using different JSON formatter set in user settings, and ignored top-level "editor.defaultFormatter". To fix that, add `jsonc` and `json` settings to `.vscode/settings.json` file as shown below.

Add the following to `.vscode/settings.json` file (if not already there):

```json
// .vscode/settings.json
{
+  "editor.defaultFormatter": "esbenp.prettier-vscode",
+  "editor.formatOnSave": true,
+  "editor.formatOnPaste": true,
+  "editor.formatOnType": false,
+  "editor.codeActionsOnSave": {
+    "source.fixAll.eslint": true,
+    "source.fixAll.html": true
+  },
+  "eslint.validate": ["svelte"],
+  "editor.tokenColorCustomizations": {
+    "[Svelte]": {
+      "textMateRules": [
+        {
+          "settings": {
+            "foreground": "#569CD6" // any color you like
+          },
+          "scope": "support.class.component.svelte" // scope name you want to adjust highlighting for
+        }
+      ]
+    }
+  },
+  "svelte.enable-ts-plugin": true,
+  "javascript.format.enable": false,
+  "files.insertFinalNewline": true,
+  "files.trimFinalNewlines": false,
+  "[json]": {
+    "editor.defaultFormatter": "esbenp.prettier-vscode"
+  },
+  "[jsonc]": {
+    "editor.defaultFormatter": "esbenp.prettier-vscode"
+  },
+  "[svelte]": {
+    "editor.defaultFormatter": "svelte.svelte-vscode"
+  },
+  "[html]": {
+    "editor.defaultFormatter": "vscode.html-language-features"
+  }
}
```

### Add Tooling

```bash
pnpm install -D glob sass shx vite-plugin-static-copy cpy
```
